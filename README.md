# ESP32C2 PHY Interface

Проект представляет собой интерфейс для работы с физическим уровнем (PHY) микроконтроллера ESP32-C2. Проект разработан с использованием ESP-IDF на основе [ESP-Hosted-FG](https://github.com/espressif/esp-hosted/tree/master/esp_hosted_fg)

## Структура проекта

```
.
├── main/                   # Основной исходный код
│   ├── app_main.c          # Точка входа приложения
│   ├── control.c/h         # Управление PHY
│   ├── wifi.c/h            # WiFi функциональность
│   ├── bt.c/h              # Bluetooth функциональность
│   └── spi_driver.c/h      # Драйвер SPI
├── CMakeLists.txt     # Основной файл сборки
└── sdkconfig          # Конфигурация проекта
```

## Требования

- ESP-IDF v5.4.0
- CMake версии 3.16 или выше
- ESP32-C2 Development Board

## Сборка проекта

1. Установите VSCode и ESP-IDF согласно [официальной документации](https://github.com/espressif/vscode-esp-idf-extension/blob/master/README.md)
2. Клонируйте репозиторий
3. Откройте в VSCode и соберите проект

## Функциональность
Проект предоставляет следующие возможности:
- Подключение по SPI (Скорость передачи SPI до 60 Мбит/с)
- WiFi (Стандартный сетевой интерфейс 802.3)
    - 802.11b/g/n
    - WLAN Station
    - WLAN Soft AP
- Bluetooth LE (Стандартный интерфейс HCI)
- Интерфейс для настройки WiFi и BLE

## SPI

### Конфигурация
- Режим: SPI Mode 2
- Максимальная скорость: 60 Мбит/с
- Использование DMA

### Сигналы управления
- MOSI (GPIO 7): Выход ведущего, вход ведомого
- MISO (GPIO 2): Вход ведущего, выход ведомого
- SCLK (GPIO 6): Тактовый сигнал
- CS (GPIO 10): Выбор устройства
- HS (GPIO 3): Сигнал подтверждения
- DR (GPIO 4): Сигнал готовности данных

### Структура пакета
```c
typedef struct {
    uint8_t type;    // Тип пакета
    uint16_t len;    // Длина данных
    uint8_t data[];  // Данные
} spi_buf;
```
```
+----------------+----------------+--------------+
|      type      |      len       |     data     |
|    (1 байт)    |   (2 байта)    |   (N байт)   |
+----------------+----------------+--------------+
```

### Типы пакетов
- `ESP_STA`: Данные WiFi станции
- `ESP_AP`: Данные WiFi точки доступа
- `ESP_BT`: Данные Bluetooth
- `ESP_CONTROL`: Управляющие команды

### Буферы
- Размер буфера: `SPI_BUF_LEN`
- Выровненные буферы для приема и передачи
- Очередь передачи: 4 элемента

### Процесс передачи
1. Хост устанавливает CS в активное состояние
2. ESP32-C2 устанавливает HS при готовности
3. Происходит обмен данными
4. ESP32-C2 устанавливает DR при наличии данных для передачи
5. Хост считывает данные и сбрасывает CS

## Control

### Структура пакета
```
+----------------+----------------+----------------+----------------+----------------+
|      id        |     type       |      len       |     queue      |  control data  |
|   (1 байт)     |    (1 байт)    |   (2 байта)    |   (4 байта)    |   (len байт)   |
+----------------+----------------+----------------+----------------+----------------+
|                                      spi data                                      |
|                                      (N байт)                                      |
+------------------------------------------------------------------------------------+
```